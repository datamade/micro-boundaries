- content_for :javascripts do

  :javascript

    $(window).resize(function () {
      var h = $(window).height(),
        offsetTop = 90; // Calculate the top offset

      $('#map').css('height', (h - offsetTop));
    }).resize();

    LeafletLib.initialize(
      $("#map")[0],
      { },
      [ 41.8781136, -87.66677956445312 ],
      11
    );

    var openMarker = function(marker, photo){
      var popup_timeout;
      var popup_exited = false;

      marker.on('mouseout', function(e){
        popup_exited = true;
        window.clearTimeout(popup_timeout);
        popup_timeout = window.setTimeout(function(){
          if(popup_exited){
            popup_exited = false;
            LeafletLib.map.closePopup();
          }
        }, 500);
      });
      $(".leaflet-popup").on("mouseover", function(e){
        popup_exited = false;
      });
      $(".leaflet-popup").on("mouseout", function(e){
        popup_exited = true;
        window.clearTimeout(popup_timeout);
        popup_timeout = window.setTimeout(function(){
          if(popup_exited){
            popup_exited = false;
            LeafletLib.map.closePopup();
          }
        }, 500);
      });
    };

    var enableMarker = function(marker, photo){

      var popup_content = "<img src='" + photo.image_url + "' width='204' height='204' style='height:204px;width:204px;'/>\
      <h3>by <a href='/user/" + photo.username + "'>" + photo.username + "</a>\
      <span class='badge btn-success'>" + photo.score + " points </span></h3>\
      Taken on " + (new Date(1000*photo.created_time)).toDateString();

      marker.bindPopup(popup_content);
      marker.on('click', function(e){
        openMarker(marker, photo);
      });
      marker.on('mouseover', function(e){
        if($(".leaflet-popup").length == 0){
          e.latlng = marker.getLatLng();
          marker.fireEvent('click', e);
        }
      });
    };

    var photos = #{@mapped_photos};
    for(var photo in photos){
      // lat/lng location exists. map it
      var m = new L.CircleMarker(
        new L.LatLng( photos[photo].latitude * 1.0, photos[photo].longitude * 1.0 ),
        {
          color: $(".microbe"+photos[photo].microbe_id).css("background-color"),
          weight: 3,
          fillOpacity: 0.7,
          opacity: 0.7
        }
      );
      enableMarker(m, photos[photo]);
      LeafletLib.addMarker( m );
    }

    LeafletLib.fitFeatures();

.row-fluid
  .span4
    %h2 Welcome to Micro-Boundaries!

    %p This is a game designed to help you experience two things: the needs of beneficial bacteria, and new places and perspectives in your urban environment. 

    %h2 The microbes
    %p There are 5 bacteria to choose from. Each of them provides a unique and beneficial service to us and our world. Some of them live in the earthâ€™s crust. Some of them live in deep water, in harsh conditions, amongst the roots of plants. Their work is ever-present and invisible.

    - @microbes.each do |microbe|
      %h4
        %a.latin{ :href => "/microbe/#{microbe.tag}" }=microbe.name
        %small{ :class => "badge #{microbe.tag} microbe#{microbe.id}" } ##{microbe.tag}

    %hr
    %h2 
      Top players
      %small 
        %a{:href => '/leaderboard'} more &raquo;
    - @users.each do |user|
      %h4
        %a{ :href => "/user/#{user.username}" }=user.username
        %small #{user.score} points
  .span8
    #map
